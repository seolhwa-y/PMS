<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.pms.inter.MapperInter">
<!-- 연관 테이블의 Collection 개체 가져오기  
	<resultMap id="getProjectInfo" type="com.pms.beans.ProBean">
		<id column="PRO_CODE" property="proCode" />
		<result column="PRO_NAME" property="proName" />
		<result column="PRO_COMMENTS" property="proComment" />
		<result column="PRO_START" property="proStart" />
		<result column="PRO_END" property="proEnd" />
		<result column="PRO_VISIBLE" property="proVisible" />
		<collection property="proMembers" javaType="java.util.ArrayList" column="PRO_CODE" ofType="com.pms.beans.ProMemberB" select="getProjectMembers"></collection>
	</resultMap>-->
	<select id="isMember" parameterType="com.pms.beans.CerB"
		resultType="string">
		SELECT PMB_PASSWORD FROM PMB WHERE PMB_CODE= #{pmbCode}
	</select>
	<select id="getPmbCode" resultType="string">
		SELECT
		NVL(TO_CHAR(TO_NUMBER(MAX(PMB_CODE))+1),TO_CHAR(SYSDATE,'YYYYMM')||'01')
		AS PMBCODE FROM PMB WHERE SUBSTR(PMB_CODE,1,6) =
		TO_CHAR(SYSDATE,'YYYYMM')
	</select>
	<select id="getClassList" resultType="com.pms.beans.CerB">
		SELECT CLA_CODE AS
		PMBCLASS,CLA_NAME ||'['|| CLA_NUM || ']' AS PMBCLASSNAME
		FROM CLA
	</select>
	<select id="getLevelList" resultType="com.pms.beans.CerB">

		SELECT MLV_CODE AS
		PMBLEVEL, MLV_NAME AS PMBLEVELNAME FROM MLV
	</select>
	<insert id="insPmb" parameterType="com.pms.beans.CerB">
		INSERT INTO PMB(PMB_CODE,
		PMB_PASSWORD, PMB_NAME, PMB_MLVCODE, PMB_CLACODE, PMB_EMAIL)
		VALUES(#{pmbCode}, #{pmbPassword}, #{pmbName}, #{pmbLevel},
		#{pmbClass}, #{pmbEmail})
	</insert>
	<insert id="insAsl" parameterType="com.pms.beans.CerB">
		INSERT INTO ASL(ASL_PMBCODE,
		ASL_DATE, ASL_PUBLICIP, ASL_PRIVATEIP, ASL_ACTION)
		VALUES(#{pmbCode},
		DEFAULT, #{aslPublicIp}, #{aslPrivateIp}, #{aslAction})
	</insert>
	<select id="getAccessInfo" parameterType="com.pms.beans.CerB"
		resultType="com.pms.beans.CerB">
		SELECT * FROM ACCESSINFO WHERE PMBCODE = #{pmbCode}
	</select>
	<select id="isAccess" parameterType="com.pms.beans.CerB"
		resultType="string">
		SELECT ASL_PUBLICIP || ':' || ASL_PRIVATEIP as ASLPUBLICIP
		FROM ASL
		WHERE TO_CHAR(ASL_DATE, 'YYMMDD') = TO_CHAR(SYSDATE, 'YYMMDD')
		AND
		ASL_PMBCODE = #{pmbCode}
		GROUP BY ASL_PMBCODE, ASL_PUBLICIP,
		ASL_PRIVATEIP
		HAVING SUM(ASL_ACTION) = 1
	</select>
	<insert id="insProject" parameterType="com.pms.beans.ProBean">
		INSERT INTO
		PRO(PRO_CODE,PRO_NAME,PRO_COMMENTS,PRO_START,PRO_END,PRO_VISIBLE)
		VALUES(#{proCode},#{proName},#{proComment},TO_DATE(#{proStart},
		'YYYY-MM-DD'),TO_DATE(#{proEnd},'YYYY-MM-DD'),#{proVisible})
	</insert>
	<select id="getMembers" parameterType="com.pms.beans.CerB"
		resultType="com.pms.beans.CerB">
		SELECT * FROM PMBMEMBERS WHERE PMBCODE != #{pmbCode}
	</select>
	<update id="insProjectMembers"
		parameterType="com.pms.beans.ProBean">
		<foreach item="memberInfo" collection="proMembers"
			separator=" " open="INSERT ALL" close="SELECT * FROM DUAL">
			INTO
			PRM(PRM_PROCODE,PRM_PMBCODE,PRM_POSITION,PRM_ACCEPT)
			VALUES(#{proCode},#{memberInfo.pmbCode},#{memberInfo.proPosition},#{memberInfo.proAccept})
		</foreach>
	</update>
	<insert id="insAuthLog" parameterType="com.pms.beans.CerLogB">
		INSERT INTO
		AUL(AUL_SPMBCODE,AUL_RPMBCODE,AUL_INVITEDATE,AUL_EXPIRE,AUL_AUTHRESULT)
		VALUES(#{spmbCode}, #{rpmbCode}, default, default, #{authResult})
	</insert>
	<select id="checkInvite" parameterType="com.pms.beans.CerLogB"
		resultType="com.pms.beans.CerLogB">
	<![CDATA[
		SELECT AUL.AUL_SPMBCODE AS SPMBCODE, PMB.PMB_NAME AS SENDERNAME,
			   AUL.AUL_RPMBCODE AS RPMBCODE, TO_CHAR(AUL.AUL_INVITEDATE,'YYMMDDHH24MISS') AS INVITEDATE
		FROM AUL INNER JOIN PMB ON AUL.AUL_SPMBCODE = PMB.PMB_CODE
		WHERE AUL_RPMBCODE = #{rpmbCode} AND
		AUL_AUTHRESULT = 'NA' AND
		SYSDATE <= AUL_INVITEDATE + (5/(24*60))  
	]]>
	</select>
	<select id="receivedInvitationInfo"
		parameterType="com.pms.beans.CerB" resultType="com.pms.beans.CerLogB">
		<![CDATA[
		SELECT 	SPMBCODE, SENDERNAME, RPMBCODE, TO_CHAR(INVITEDATE,'YYYYMMDDHH24MISS') AS INVITEDATE, 
				TO_CHAR(EXPIREDATE, 'YYYYMMDDHH24MISS') AS EXPIREDATE, AUTHRESULT
		FROM RINVITEINFO 
		WHERE RPMBCODE = #{pmbCode} AND INVITEDATE >= (SYSDATE - 1)
		]]>
	</select>
	<update id="updAulState" parameterType="com.pms.beans.CerLogB">
		<![CDATA[
		UPDATE AUL SET AUL_AUTHRESULT=#{authResult} 
		WHERE AUL_SPMBCODE =#{spmbCode} AND AUL_RPMBCODE=#{rpmbCode} AND AUL_INVITEDATE = TO_DATE(#{inviteDate},'YYMMDDHH24MISS')
		]]>
	</update>
	<select id="sendInvitationInfo"
		parameterType="com.pms.beans.CerB" resultType="com.pms.beans.CerLogB">
	<![CDATA[
		SELECT 	SPMBCODE, RPMBCODE, RECEIVERNAME, TO_CHAR(INVITEDATE,'YYYYMMDDHH24MISS') AS INVITEDATE, 
				TO_CHAR(EXPIREDATE, 'YYYYMMDDHH24MISS') AS EXPIREDATE, AUTHRESULT, AUTHRESULTNAME
		FROM SINVITEINFO
		WHERE SPMBCODE = #{pmbCode} AND INVITEDATE >= (SYSDATE - 2)
		]]>
	</select>
	<update id="updPrmState" parameterType="com.pms.beans.ProBean">
		<foreach item="memberInfo" collection="proMembers"
			separator=" ">
		<![CDATA[
		UPDATE PRM SET PRM_ACCEPT=#{memberInfo.proAccept} 
		WHERE PRM_PROCODE = #{proCode} AND PRM_PMBCODE = #{memberInfo.pmbCode}
		]]>
		</foreach>
	</update>
	<update id="updProjectMembers"
		parameterType="com.pms.beans.EmailCerB">
		UPDATE PRM
		SET PRM_ACCEPT = #{proAcceptCode}
		WHERE
		PRM_PROCODE = #{emailCode} AND PRM_PMBCODE = #{receiver}
	</update>
	<update id="updAuthLog" parameterType="com.pms.beans.EmailCerB">
		UPDATE AUL
		SET
		AUL_AUTHRESULT = #{aulResultCode}
		WHERE
		AUL_SPMBCODE = #{sander} AND
		AUL_RPMBCODE = #{receiver} AND
		AUL_INVITEDATE = TO_DATE(#{inviteDate},
		'YYYYMMDDHH24MISS')
	</update>
	<select id="getProjectInfo"
		parameterType="com.pms.beans.CerB"
		resultType="com.pms.beans.ProjectInfoB">
		SELECT PROCODE, PRONAME, "PERIOD",
		PRM.PRM_PMBCODE AS
		DIRCODE,
		PMB.PMB_NAME AS DIRECTOR
		FROM MYPROJECT MP INNER JOIN PRM ON
		MP.PROCODE = PRM.PRM_PROCODE
		INNER JOIN PMB ON PRM.PRM_PMBCODE =
		PMB.PMB_CODE
		WHERE MP.PMBCODE = #{pmbCode} AND MP.PRMACCEPT = 'AC' AND
		PRM.PRM_POSITION
		= 'MG'
	</select>
	<select id="getMemberNum" parameterType = "com.pms.beans.ProjectInfoB" resultType="string">
		<![CDATA[
		SELECT COUNT(*) AS PEOPLE FROM PRM WHERE PRM_PROCODE = #{proCode} AND PRM_ACCEPT = 'AC'
		]]>
	</select>
	
		<!-- 연관 테이블의 Collection 개체 가져오기  
	<select id="getProject" parameterType="com.pms.beans.CerB" resultMap="getProjectInfo">
		SELECT * 
		FROM PRO 
		WHERE PRO_CODE IN(SELECT PRM_PROCODE FROM PRM WHERE PRM_PMBCODE = #{pmbCode})
	</select>
	<select id="getProjectMembers" resultType="com.pms.beans.ProMemberB">
		SELECT 	PRM_PMBCODE AS PMBCODE, 
				PRM_POSITION AS PROPOSITION, 
				PRM_ACCEPT AS PROACCEPT 
		FROM PRM 
		WHERE PRM_PROCODE = #{proCode}
	</select>-->
</mapper>
